<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>DB Admin GUI</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <h1>Commencement Database Admin</h1>

  <section id="students">
    <h2>Students</h2>
    <form id="studentForm">
      <div><input placeholder="PID" name="PID" required></div>
      <div><input placeholder="Name" name="name" required></div>
      <div><input placeholder="Email" name="email" type="email" required></div>
      <div><input placeholder="Degree Name" name="degree_name"></div>
      <div><input placeholder="Degree Type" name="degree_type"></div>
      <div class="toggle">
          <input type="checkbox" name="opt_in_biometric" id="opt_in_biometric">
          <label for="opt_in_biometric">Opt-in Biometric</label>
      </div>
      <button type="submit">Insert Student</button>
    </form>
    <table id="studentsTable">
      <thead><tr><th>PID</th><th>Name</th><th>Email</th><th>Degree</th><th>Type</th><th>Biometric</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="ceremonies">
    <h2>Ceremonies</h2>
    <form id="ceremonyForm">
      <div><input placeholder="Name" name="name" required></div>
      <div><input placeholder="Date-Time (YYYY-MM-DD HH:MM:SS)" name="date_time" required></div>
      <div><input placeholder="Location" name="location" required></div>
      <div><input placeholder="Start Time (HH:MM:SS)" name="start_time" required></div>
      <div><input placeholder="End Time (HH:MM:SS)" name="end_time" required></div>
      <button type="submit">Insert Ceremony</button>
    </form>
    <table id="ceremoniesTable">
      <thead><tr><th>ID</th><th>Name</th><th>Date-Time</th><th>Location</th><th>Start</th><th>End</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="staff">
    <h2>Staff</h2>
    <form id="staffForm">
      <div><input placeholder="Staff ID" name="staff_id" required></div>
      <div><input placeholder="Name" name="name" required></div>
      <div><input placeholder="Email" name="email" type="email" required></div>
      <div><input placeholder="Status" name="status" value="active"></div>
      <button type="submit">Insert Staff</button>
    </form>
    <table id="staffTable">
      <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

<script>
const API = (path) => (location.origin.includes("127.0.0.1") || location.origin.includes("localhost"))
  ? `http://127.0.0.1:8000${path}` : `${location.origin}${path}`;

async function fetchJSON(url, opts = {}) {
  const res = await fetch(url, { headers: { "Content-Type": "application/json" }, ...opts });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || res.statusText);
  }
  return res.json();
}

async function loadStudents() {
  const data = await fetchJSON(API("/students/"));
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.PID}</td><td>${r.name}</td><td>${r.email}</td>
      <td>${r.degree_name ?? ""}</td><td>${r.degree_type ?? ""}</td>
      <td>${r.opt_in_biometric ? "Yes" : "No"}</td>
      <td><button data-pid="${r.PID}" class="del-student">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadCeremonies() {
  const data = await fetchJSON(API("/ceremonies/"));
  const tbody = document.querySelector("#ceremoniesTable tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.ceremony_id}</td><td>${r.name}</td><td>${r.date_time}</td>
      <td>${r.location}</td><td>${r.start_time}</td><td>${r.end_time}</td>
      <td><button data-id="${r.ceremony_id}" class="del-ceremony">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadStaff() {
  const data = await fetchJSON(API("/staff/"));
  const tbody = document.querySelector("#staffTable tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.staff_id}</td><td>${r.name}</td><td>${r.email}</td><td>${r.status}</td>
      <td><button data-id="${r.staff_id}" class="del-staff">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("studentForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    PID: fd.get("PID"),
    name: fd.get("name"),
    email: fd.get("email"),
    degree_name: fd.get("degree_name") || null,
    degree_type: fd.get("degree_type") || null,
    opt_in_biometric: fd.get("opt_in_biometric") === "on",
  };
  await fetchJSON(API("/students/"), { method: "POST", body: JSON.stringify(payload) });
  e.target.reset();
  await loadStudents();
});

document.getElementById("ceremonyForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    name: fd.get("name"),
    date_time: fd.get("date_time").replace("T", " "),
    location: fd.get("location"),
    start_time: fd.get("start_time"),
    end_time: fd.get("end_time"),
  };
  await fetchJSON(API("/ceremonies/"), { method: "POST", body: JSON.stringify(payload) });
  e.target.reset();
  await loadCeremonies();
});

document.getElementById("staffForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    staff_id: fd.get("staff_id"),
    name: fd.get("name"),
    email: fd.get("email"),
    status: fd.get("status") || "active",
  };
  await fetchJSON(API("/staff/"), { method: "POST", body: JSON.stringify(payload) });
  e.target.reset();
  await loadStaff();
});

document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("del-student")) {
    await fetchJSON(API("/students/") + e.target.dataset.pid, { method: "DELETE" });
    await loadStudents();
  }
  if (e.target.classList.contains("del-ceremony")) {
    await fetchJSON(API("/ceremonies/") + e.target.dataset.id, { method: "DELETE" });
    await loadCeremonies();
  }
  if (e.target.classList.contains("del-staff")) {
    await fetchJSON(API("/staff/") + e.target.dataset.id, { method: "DELETE" });
    await loadStaff();
  }
});

async function init() {
  await loadStudents();
  await loadCeremonies();
  await loadStaff();
}
init();
</script>
</body>
</html>
